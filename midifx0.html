<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChasmFX - MIDI Effects Processor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', 'Consolas', monospace;
            background: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #1a1a1a;
            padding: 10px;
            border-bottom: 2px solid #333;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .logo {
            height: 50px;
            display: flex;
            align-items: center;
            margin-right: 10px;
        }

        .logo svg {
            height: 100%;
            width: auto;
        }

        .header-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header label {
            font-size: 12px;
            color: #aaa;
        }

        .header input, .header select, .header button {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 5px 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .header button {
            cursor: pointer;
            min-width: 60px;
        }

        .header button:hover {
            background: #3a3a3a;
        }

        .header button.active {
            background: #4a4a4a;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            display: inline-block;
            margin-left: 5px;
        }

        .status-indicator.connected {
            background: #0f0;
            box-shadow: 0 0 5px #0f0;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .effects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .effect-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 4px;
        }

        .effect-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .effect-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #444;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #0066cc;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 28px;
        }

        .param-group {
            margin-bottom: 15px;
        }

        .param-label {
            display: block;
            color: #aaa;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .param-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .param-controls input[type="range"] {
            flex: 1;
        }

        .param-controls input[type="number"],
        .param-controls input[type="text"],
        .param-controls select {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 5px 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            width: 80px;
        }

        .param-value {
            color: #4caf50;
            font-weight: bold;
            min-width: 50px;
            text-align: right;
        }

        .midi-activity {
            width: 100%;
            height: 4px;
            background: #222;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .midi-activity-bar {
            height: 100%;
            background: #0f0;
            width: 0%;
            transition: width 0.1s;
        }

        .midi-activity-bar.active {
            width: 100%;
            transition: width 0.3s;
        }

        .note-display {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            min-height: 60px;
            max-height: 120px;
            overflow-y: auto;
            color: #0f0;
        }

        .note-item {
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 80" width="400" height="80">
                    <defs>
                        <linearGradient id="chasmGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#0066cc;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#4a90e2;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#0066cc;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="trackerGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#888;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#fff;stop-opacity:1" />
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <rect x="0" y="0" width="400" height="80" fill="#000"/>
                    <path d="M 0 40 L 100 20 L 200 35 L 300 25 L 400 40" 
                          stroke="#0066cc" 
                          stroke-width="2" 
                          fill="none" 
                          opacity="0.3"/>
                    <path d="M 0 50 L 100 30 L 200 45 L 300 35 L 400 50" 
                          stroke="#0066cc" 
                          stroke-width="1.5" 
                          fill="none" 
                          opacity="0.2"/>
                    <text x="20" y="50" 
                          font-family="'Courier New', 'Consolas', monospace" 
                          font-size="42" 
                          font-weight="bold" 
                          fill="url(#chasmGradient)"
                          filter="url(#glow)"
                          letter-spacing="2">CHASM</text>
                    <text x="20" y="70" 
                          font-family="'Courier New', 'Consolas', monospace" 
                          font-size="18" 
                          fill="url(#trackerGradient)"
                          letter-spacing="4">FX</text>
                </svg>
            </div>
            <div class="header-group">
                <label>MIDI In:</label>
                <select id="midiInputSelect">
                    <option value="">No Input</option>
                </select>
                <span class="status-indicator" id="inputStatus"></span>
            </div>
            <div class="header-group">
                <label>MIDI Out:</label>
                <select id="midiOutputSelect">
                    <option value="">No Output</option>
                </select>
                <span class="status-indicator" id="outputStatus"></span>
            </div>
            <div class="header-group">
                <label>BPM:</label>
                <input type="number" id="bpmInput" value="120" min="32" max="255" style="width: 60px;">
            </div>
            <div class="header-group">
                <button id="requestMIDIBtn" style="display: none;">Request MIDI Access</button>
                <button id="refreshBtn">Refresh</button>
            </div>
        </div>

        <div class="main-content">
            <div class="effects-grid">
                <!-- Delay Effect -->
                <div class="effect-panel">
                    <div class="effect-header">
                        <div class="effect-title">Delay</div>
                        <div class="toggle-switch" id="delayToggle"></div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Time Mode</label>
                        <select id="delayTimeMode" style="width: 100%;">
                            <option value="ms">Milliseconds</option>
                            <option value="bpm">BPM Sync</option>
                        </select>
                    </div>
                    <div class="param-group" id="delayMsGroup">
                        <label class="param-label">Delay Time (ms)</label>
                        <div class="param-controls">
                            <input type="range" id="delayMs" min="10" max="2000" value="250" step="10">
                            <span class="param-value" id="delayMsValue">250</span>
                        </div>
                    </div>
                    <div class="param-group" id="delayBpmGroup" style="display: none;">
                        <label class="param-label">Note Division</label>
                        <select id="delayBpmDivision" style="width: 100%;">
                            <option value="1/1">1/1 (Whole)</option>
                            <option value="1/2">1/2 (Half)</option>
                            <option value="1/4" selected>1/4 (Quarter)</option>
                            <option value="1/8">1/8 (Eighth)</option>
                            <option value="1/16">1/16 (Sixteenth)</option>
                            <option value="1/32">1/32 (Thirty-second)</option>
                            <option value="3/8">3/8 (Dotted Quarter)</option>
                            <option value="3/16">3/16 (Dotted Eighth)</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Feedback (%)</label>
                        <div class="param-controls">
                            <input type="range" id="delayFeedback" min="0" max="100" value="50" step="1">
                            <span class="param-value" id="delayFeedbackValue">50</span>
                        </div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Velocity Decay (%)</label>
                        <div class="param-controls">
                            <input type="range" id="delayVelocityDecay" min="0" max="100" value="20" step="1">
                            <span class="param-value" id="delayVelocityDecayValue">20</span>
                        </div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Panning</label>
                        <select id="delayPanning" style="width: 100%;">
                            <option value="none">None</option>
                            <option value="alternating">Alternating (L-R-L-R)</option>
                            <option value="spread">Spread</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Filtering</label>
                        <select id="delayFiltering" style="width: 100%;">
                            <option value="none">None</option>
                            <option value="lowpass">Lowpass Decay</option>
                            <option value="highpass">Highpass Decay</option>
                        </select>
                    </div>
                    <div class="midi-activity">
                        <div class="midi-activity-bar" id="delayActivity"></div>
                    </div>
                </div>

                <!-- Arpeggiator -->
                <div class="effect-panel">
                    <div class="effect-header">
                        <div class="effect-title">Arpeggiator</div>
                        <div class="toggle-switch" id="arpToggle"></div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Rate (Note Division)</label>
                        <select id="arpRate" style="width: 100%;">
                            <option value="1/1">1/1 (Whole)</option>
                            <option value="1/2">1/2 (Half)</option>
                            <option value="1/4" selected>1/4 (Quarter)</option>
                            <option value="1/8">1/8 (Eighth)</option>
                            <option value="1/16">1/16 (Sixteenth)</option>
                            <option value="1/32">1/32 (Thirty-second)</option>
                            <option value="1/64">1/64 (Sixty-fourth)</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Pattern</label>
                        <select id="arpPattern" style="width: 100%;">
                            <option value="up">Up</option>
                            <option value="down">Down</option>
                            <option value="updown" selected>Up/Down</option>
                            <option value="random">Random</option>
                            <option value="asplayed">As Played</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Octave Range</label>
                        <div class="param-controls">
                            <input type="range" id="arpOctaveRange" min="1" max="4" value="1" step="1">
                            <span class="param-value" id="arpOctaveRangeValue">1</span>
                        </div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Hold</label>
                        <div class="toggle-switch" id="arpHoldToggle"></div>
                    </div>
                    <div class="midi-activity">
                        <div class="midi-activity-bar" id="arpActivity"></div>
                    </div>
                </div>

                <!-- Chord Generator -->
                <div class="effect-panel">
                    <div class="effect-header">
                        <div class="effect-title">Chord Generator</div>
                        <div class="toggle-switch" id="chordToggle"></div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Chord Type</label>
                        <select id="chordType" style="width: 100%;">
                            <option value="major">Major</option>
                            <option value="minor">Minor</option>
                            <option value="diminished">Diminished</option>
                            <option value="augmented">Augmented</option>
                            <option value="sus2">Sus2</option>
                            <option value="sus4">Sus4</option>
                            <option value="major7">Major 7th</option>
                            <option value="minor7">Minor 7th</option>
                            <option value="dominant7">Dominant 7th</option>
                            <option value="diminished7">Diminished 7th</option>
                        </select>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Inversion</label>
                        <div class="param-controls">
                            <input type="range" id="chordInversion" min="0" max="2" value="0" step="1">
                            <span class="param-value" id="chordInversionValue">0</span>
                        </div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Trigger Mode</label>
                        <select id="chordTriggerMode" style="width: 100%;">
                            <option value="onnote">On Note</option>
                            <option value="always">Always</option>
                        </select>
                    </div>
                    <div class="midi-activity">
                        <div class="midi-activity-bar" id="chordActivity"></div>
                    </div>
                </div>

                <!-- Transpose -->
                <div class="effect-panel">
                    <div class="effect-header">
                        <div class="effect-title">Transpose</div>
                        <div class="toggle-switch" id="transposeToggle"></div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Semitones</label>
                        <div class="param-controls">
                            <input type="range" id="transposeSemitones" min="-12" max="12" value="0" step="1">
                            <span class="param-value" id="transposeSemitonesValue">0</span>
                        </div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Mode</label>
                        <select id="transposeMode" style="width: 100%;">
                            <option value="global">Global</option>
                            <option value="perchannel">Per Channel</option>
                        </select>
                    </div>
                    <div class="midi-activity">
                        <div class="midi-activity-bar" id="transposeActivity"></div>
                    </div>
                </div>

                <!-- Velocity Processor -->
                <div class="effect-panel">
                    <div class="effect-header">
                        <div class="effect-title">Velocity Processor</div>
                        <div class="toggle-switch" id="velocityToggle"></div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Min Velocity</label>
                        <div class="param-controls">
                            <input type="range" id="velocityMin" min="1" max="127" value="1" step="1">
                            <span class="param-value" id="velocityMinValue">1</span>
                        </div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Max Velocity</label>
                        <div class="param-controls">
                            <input type="range" id="velocityMax" min="1" max="127" value="127" step="1">
                            <span class="param-value" id="velocityMaxValue">127</span>
                        </div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Random Variation</label>
                        <div class="param-controls">
                            <input type="range" id="velocityRandom" min="0" max="50" value="0" step="1">
                            <span class="param-value" id="velocityRandomValue">0</span>
                        </div>
                    </div>
                    <div class="midi-activity">
                        <div class="midi-activity-bar" id="velocityActivity"></div>
                    </div>
                </div>

                <!-- MIDI Monitor -->
                <div class="effect-panel">
                    <div class="effect-header">
                        <div class="effect-title">MIDI Monitor</div>
                    </div>
                    <div class="note-display" id="midiMonitor">
                        <div style="color: #666;">Waiting for MIDI input...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="midi-synths.js"></script>
    <script>
        // State
        const state = {
            midiManager: null,
            midiInput: null,
            midiOutput: null,
            bpm: 120,
            effects: {
                delay: { enabled: false, queue: [], activeRepeats: new Map() },
                arp: { enabled: false, heldNotes: [], currentIndex: 0, arpTimer: null, hold: false },
                chord: { enabled: false },
                transpose: { enabled: false, semitones: 0 },
                velocity: { enabled: false, min: 1, max: 127, random: 0 }
            },
            activeNotes: new Map(),
            lastMidiActivity: { input: 0, output: 0 }
        };

        // Chord intervals (semitones from root)
        const chordIntervals = {
            major: [0, 4, 7],
            minor: [0, 3, 7],
            diminished: [0, 3, 6],
            augmented: [0, 4, 8],
            sus2: [0, 2, 7],
            sus4: [0, 5, 7],
            major7: [0, 4, 7, 11],
            minor7: [0, 3, 7, 10],
            dominant7: [0, 4, 7, 10],
            diminished7: [0, 3, 6, 9]
        };

        // Initialize MIDI
        async function initMIDI() {
            try {
                if (!navigator.requestMIDIAccess) {
                    console.warn('Web MIDI API not supported');
                    document.getElementById('requestMIDIBtn').style.display = 'none';
                    return;
                }
                
                state.midiManager = new MidiManager();
                const success = await state.midiManager.initialize();
                if (success) {
                    // Small delay to ensure devices are enumerated
                    setTimeout(() => {
                        updateDeviceLists();
                        state.midiManager.onStateChange = updateDeviceLists;
                    }, 100);
                    document.getElementById('requestMIDIBtn').style.display = 'none';
                } else {
                    console.warn('MIDI initialization failed - user may need to grant permission');
                    document.getElementById('requestMIDIBtn').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Error initializing MIDI:', error);
                document.getElementById('requestMIDIBtn').style.display = 'inline-block';
            }
        }

        function updateDeviceLists() {
            const inputSelect = document.getElementById('midiInputSelect');
            const outputSelect = document.getElementById('midiOutputSelect');
            
            // Get current selections by name (more reliable than index)
            const currentInputName = inputSelect.options[inputSelect.selectedIndex]?.textContent;
            const currentOutputName = outputSelect.options[outputSelect.selectedIndex]?.textContent;
            
            // Clear options
            inputSelect.innerHTML = '<option value="">No Input</option>';
            outputSelect.innerHTML = '<option value="">No Output</option>';
            
            // Update inputs
            if (state.midiManager && state.midiManager.midiAccess) {
                const inputs = Array.from(state.midiManager.midiAccess.inputs.values());
                console.log(`Found ${inputs.length} MIDI input devices`);
                inputs.forEach((input, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = input.name || `Input ${index + 1}`;
                    if (input.name === currentInputName) option.selected = true;
                    inputSelect.appendChild(option);
                });
            } else {
                console.log('No MIDI access available for inputs');
            }
            
            // Update outputs - refresh device list first
            if (state.midiManager) {
                state.midiManager.updateDeviceList();
                const devices = state.midiManager.getDevices();
                console.log(`Found ${devices.length} MIDI output devices`);
                devices.forEach((output, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = output.name || `Output ${index + 1}`;
                    if (output.name === currentOutputName) option.selected = true;
                    outputSelect.appendChild(option);
                });
            } else {
                console.log('No MIDI manager available for outputs');
            }
            
            updateStatusIndicators();
        }

        function updateStatusIndicators() {
            const inputStatus = document.getElementById('inputStatus');
            const outputStatus = document.getElementById('outputStatus');
            
            inputStatus.className = 'status-indicator' + (state.midiInput ? ' connected' : '');
            outputStatus.className = 'status-indicator' + (state.midiOutput ? ' connected' : '');
        }

        function connectMIDIInput(index) {
            if (!state.midiManager || !state.midiManager.midiAccess) return;
            
            const inputs = Array.from(state.midiManager.midiAccess.inputs.values());
            if (index >= 0 && index < inputs.length) {
                // Disconnect previous
                if (state.midiInput) {
                    state.midiInput.onmidimessage = null;
                }
                
                state.midiInput = inputs[index];
                state.midiInput.onmidimessage = handleMIDIMessage;
                updateStatusIndicators();
            } else {
                state.midiInput = null;
                updateStatusIndicators();
            }
        }

        function connectMIDIOutput(index) {
            if (!state.midiManager) return;
            
            const success = state.midiManager.connect(index);
            if (success) {
                state.midiOutput = state.midiManager.midiOutput;
            } else {
                state.midiOutput = null;
            }
            updateStatusIndicators();
        }

        function handleMIDIMessage(event) {
            const [status, data1, data2] = event.data;
            const messageType = status & 0xF0;
            const channel = status & 0x0F;
            
            // Update activity
            state.lastMidiActivity.input = Date.now();
            updateMidiActivity('input');
            updateMidiMonitor(status, data1, data2);
            
            // Process through effect chain
            processMIDIMessage(status, data1, data2, channel);
        }

        function processMIDIMessage(status, data1, data2, channel) {
            let processedStatus = status;
            let processedData1 = data1;
            let processedData2 = data2;
            let processedChannel = channel;
            
            // Note On (0x90) or Note Off (0x80)
            if ((status & 0xF0) === 0x90 || (status & 0xF0) === 0x80) {
                const isNoteOn = (status & 0xF0) === 0x90 && data2 > 0;
                const isNoteOff = (status & 0xF0) === 0x80 || ((status & 0xF0) === 0x90 && data2 === 0);
                const note = data1;
                const velocity = data2;
                
                // Handle note off for arpeggiator
                if (state.effects.arp.enabled && isNoteOff && !state.effects.arp.hold) {
                    state.effects.arp.heldNotes = state.effects.arp.heldNotes.filter(
                        n => !(n.note === note && n.channel === channel)
                    );
                    // Send note off immediately
                    sendMIDI(0x80 | channel, note, 0);
                    return;
                }
                
                // Apply effects in order (only for note on)
                if (isNoteOn) {
                    if (state.effects.chord.enabled) {
                        const chordNotes = generateChord(note);
                        chordNotes.forEach(chordNote => {
                            sendMIDI(0x90 | processedChannel, chordNote, velocity);
                        });
                        return; // Don't send original note
                    }
                    
                    if (state.effects.transpose.enabled) {
                        processedData1 = Math.max(0, Math.min(127, note + state.effects.transpose.semitones));
                    }
                    
                    if (state.effects.velocity.enabled) {
                        let newVelocity = velocity;
                        if (velocity < state.effects.velocity.min) newVelocity = state.effects.velocity.min;
                        if (velocity > state.effects.velocity.max) newVelocity = state.effects.velocity.max;
                        if (state.effects.velocity.random > 0) {
                            const variation = Math.floor(Math.random() * state.effects.velocity.random * 2) - state.effects.velocity.random;
                            newVelocity = Math.max(1, Math.min(127, newVelocity + variation));
                        }
                        processedData2 = newVelocity;
                    }
                    
                    if (state.effects.arp.enabled) {
                        handleArpeggiatorNote(note, processedData2, channel);
                        return; // Arp handles sending
                    }
                    
                    if (state.effects.delay.enabled) {
                        handleDelayNote(note, processedData2, channel);
                    }
                } else if (isNoteOff) {
                    // Handle note off with transpose
                    if (state.effects.transpose.enabled) {
                        processedData1 = Math.max(0, Math.min(127, note + state.effects.transpose.semitones));
                    }
                    processedStatus = 0x80 | channel;
                }
                
                // Send processed note
                sendMIDI(processedStatus, processedData1, processedData2);
            } else {
                // Other MIDI messages pass through
                sendMIDI(status, data1, data2);
            }
        }

        function sendMIDI(status, data1, data2) {
            if (!state.midiOutput) return;
            
            state.midiOutput.send([status, data1, data2]);
            state.lastMidiActivity.output = Date.now();
            updateMidiActivity('output');
        }

        // Delay Effect
        function handleDelayNote(note, velocity, channel) {
            const delayTime = getDelayTime();
            const feedback = state.effects.delay.feedback / 100;
            const velocityDecay = state.effects.delay.velocityDecay / 100;
            
            // Schedule delayed note
            const delayItem = {
                note,
                velocity,
            channel,
                repeat: 0,
                panIndex: 0
            };
            
            scheduleDelayedNote(delayItem, delayTime);
        }

        function scheduleDelayedNote(delayItem, delayTime) {
            setTimeout(() => {
                if (!state.effects.delay.enabled) return;
                
                const feedback = state.effects.delay.feedback / 100;
                const velocityDecay = state.effects.delay.velocityDecay / 100;
                
                // Calculate new velocity with decay
                let newVelocity = Math.floor(delayItem.velocity * Math.pow(1 - velocityDecay, delayItem.repeat));
                newVelocity = Math.max(1, Math.min(127, newVelocity));
                
                // Apply panning via CC
                if (state.effects.delay.panning === 'alternating') {
                    const panValue = delayItem.panIndex % 2 === 0 ? 0 : 127;
                    sendMIDI(0xB0 | delayItem.channel, 10, panValue);
                    delayItem.panIndex++;
                } else if (state.effects.delay.panning === 'spread') {
                    const panValue = Math.floor((delayItem.repeat / 8) * 127);
                    sendMIDI(0xB0 | delayItem.channel, 10, panValue);
                }
                
                // Apply filtering via CC
                if (state.effects.delay.filtering === 'lowpass') {
                    const cutoff = Math.max(0, 127 - (delayItem.repeat * 10));
                    sendMIDI(0xB0 | delayItem.channel, 74, cutoff);
                } else if (state.effects.delay.filtering === 'highpass') {
                    const cutoff = Math.min(127, delayItem.repeat * 10);
                    sendMIDI(0xB0 | delayItem.channel, 74, cutoff);
                }
                
                // Send delayed note
                sendMIDI(0x90 | delayItem.channel, delayItem.note, newVelocity);
                
                // Schedule feedback if enabled
                if (feedback > 0 && delayItem.repeat < 10) {
                    delayItem.repeat++;
                    delayItem.velocity = newVelocity;
                    scheduleDelayedNote(delayItem, getDelayTime());
                }
                
                updateMidiActivity('delay');
            }, delayTime);
        }

        function getDelayTime() {
            const timeMode = document.getElementById('delayTimeMode').value;
            if (timeMode === 'ms') {
                return parseInt(document.getElementById('delayMs').value);
            } else {
                const division = document.getElementById('delayBpmDivision').value;
                const [numerator, denominator] = division.split('/').map(Number);
                const beatTime = (60000 / state.bpm);
                return beatTime * (numerator / denominator);
            }
        }

        // Arpeggiator
        function handleArpeggiatorNote(note, velocity, channel) {
            if (!state.effects.arp.heldNotes.find(n => n.note === note && n.channel === channel)) {
                state.effects.arp.heldNotes.push({ note, velocity, channel });
            }
            
            if (!state.effects.arp.arpTimer) {
                startArpeggiator();
            }
        }

        function startArpeggiator() {
            if (state.effects.arp.arpTimer) return;
            
            const rate = getArpRate();
            state.effects.arp.arpTimer = setInterval(() => {
                if (!state.effects.arp.enabled) {
                    stopArpeggiator();
                    return;
                }
                
                if (state.effects.arp.heldNotes.length === 0 && !state.effects.arp.hold) {
                    stopArpeggiator();
                    return;
                }
                
                if (state.effects.arp.heldNotes.length === 0) return;
                
                // Get notes to arpeggiate
                const notes = getArpNotes();
                if (notes.length === 0) return;
                
                // Stop previous note
                if (state.effects.arp.currentNote) {
                    sendMIDI(0x80 | state.effects.arp.currentNote.channel, state.effects.arp.currentNote.note, 0);
                }
                
                // Play current note
                const current = notes[state.effects.arp.currentIndex % notes.length];
                sendMIDI(0x90 | current.channel, current.note, current.velocity);
                state.effects.arp.currentNote = current;
                
                state.effects.arp.currentIndex++;
                updateMidiActivity('arp');
            }, rate);
        }

        function stopArpeggiator() {
            if (state.effects.arp.arpTimer) {
                clearInterval(state.effects.arp.arpTimer);
                state.effects.arp.arpTimer = null;
            }
            
            // Stop current note
            if (state.effects.arp.currentNote) {
                sendMIDI(0x80 | state.effects.arp.currentNote.channel, state.effects.arp.currentNote.note, 0);
                state.effects.arp.currentNote = null;
            }
            
            state.effects.arp.currentIndex = 0;
        }

        function getArpNotes() {
            if (state.effects.arp.heldNotes.length === 0) return [];
            
            const pattern = document.getElementById('arpPattern').value;
            const octaveRange = parseInt(document.getElementById('arpOctaveRange').value);
            
            let notes = [...state.effects.arp.heldNotes];
            
            // Sort notes
            if (pattern === 'up') {
                notes.sort((a, b) => a.note - b.note);
            } else if (pattern === 'down') {
                notes.sort((a, b) => b.note - a.note);
            } else if (pattern === 'updown') {
                notes.sort((a, b) => a.note - b.note);
                const down = [...notes].reverse().slice(1);
                notes = notes.concat(down);
            } else if (pattern === 'random') {
                // Shuffle
                for (let i = notes.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [notes[i], notes[j]] = [notes[j], notes[i]];
                }
            }
            // 'asplayed' keeps original order
            
            // Expand with octaves
            const expandedNotes = [];
            for (let oct = 0; oct < octaveRange; oct++) {
                notes.forEach(note => {
                    const octaveNote = note.note + (oct * 12);
                    if (octaveNote >= 0 && octaveNote <= 127) {
                        expandedNotes.push({
                            note: octaveNote,
                            velocity: note.velocity,
                            channel: note.channel
                        });
                    }
                });
            }
            
            return expandedNotes;
        }

        function getArpRate() {
            const division = document.getElementById('arpRate').value;
            const [numerator, denominator] = division.split('/').map(Number);
            const beatTime = (60000 / state.bpm);
            return beatTime * (numerator / denominator);
        }

        // Chord Generator
        function generateChord(rootNote) {
            const chordType = document.getElementById('chordType').value;
            const inversion = parseInt(document.getElementById('chordInversion').value);
            const intervals = chordIntervals[chordType];
            
            let notes = intervals.map(interval => {
                const note = rootNote + interval;
                return note >= 0 && note <= 127 ? note : null;
            }).filter(n => n !== null);
            
            // Apply inversion
            if (inversion > 0 && inversion < notes.length) {
                const inverted = notes.slice(inversion).concat(notes.slice(0, inversion).map(n => n + 12));
                notes = inverted.filter(n => n >= 0 && n <= 127);
            }
            
            return notes;
        }

        // MIDI Monitor
        function updateMidiMonitor(status, data1, data2) {
            const monitor = document.getElementById('midiMonitor');
            const messageType = status & 0xF0;
            const channel = status & 0x0F;
            
            let message = '';
            if (messageType === 0x90) {
                message = `Note On: Ch${channel + 1} Note ${data1} Vel ${data2}`;
            } else if (messageType === 0x80) {
                message = `Note Off: Ch${channel + 1} Note ${data1}`;
            } else {
                message = `MIDI: ${status.toString(16)} ${data1} ${data2}`;
            }
            
            const item = document.createElement('div');
            item.className = 'note-item';
            item.textContent = message;
            monitor.insertBefore(item, monitor.firstChild);
            
            // Keep only last 20 messages
            while (monitor.children.length > 20) {
                monitor.removeChild(monitor.lastChild);
            }
        }

        function updateMidiActivity(effect) {
            const activityBar = document.getElementById(effect + 'Activity');
            if (activityBar) {
                activityBar.classList.add('active');
                setTimeout(() => {
                    activityBar.classList.remove('active');
                }, 100);
            }
        }

        // Event Listeners
        document.getElementById('midiInputSelect').addEventListener('change', (e) => {
            const index = parseInt(e.target.value);
            connectMIDIInput(isNaN(index) ? -1 : index);
        });

        document.getElementById('midiOutputSelect').addEventListener('change', (e) => {
            const index = parseInt(e.target.value);
            connectMIDIOutput(isNaN(index) ? -1 : index);
        });

        document.getElementById('requestMIDIBtn').addEventListener('click', async () => {
            await initMIDI();
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            if (state.midiManager) {
                // Re-initialize to refresh device list
                await state.midiManager.initialize();
            }
            updateDeviceLists();
        });

        document.getElementById('bpmInput').addEventListener('input', (e) => {
            state.bpm = parseInt(e.target.value) || 120;
        });

        // Delay controls
        document.getElementById('delayToggle').addEventListener('click', () => {
            state.effects.delay.enabled = !state.effects.delay.enabled;
            document.getElementById('delayToggle').classList.toggle('active', state.effects.delay.enabled);
        });

        document.getElementById('delayTimeMode').addEventListener('change', (e) => {
            document.getElementById('delayMsGroup').style.display = e.target.value === 'ms' ? 'block' : 'none';
            document.getElementById('delayBpmGroup').style.display = e.target.value === 'bpm' ? 'block' : 'none';
        });

        document.getElementById('delayMs').addEventListener('input', (e) => {
            document.getElementById('delayMsValue').textContent = e.target.value;
        });

        document.getElementById('delayFeedback').addEventListener('input', (e) => {
            state.effects.delay.feedback = parseInt(e.target.value);
            document.getElementById('delayFeedbackValue').textContent = e.target.value;
        });

        document.getElementById('delayVelocityDecay').addEventListener('input', (e) => {
            state.effects.delay.velocityDecay = parseInt(e.target.value);
            document.getElementById('delayVelocityDecayValue').textContent = e.target.value;
        });

        document.getElementById('delayPanning').addEventListener('change', (e) => {
            state.effects.delay.panning = e.target.value;
        });

        document.getElementById('delayFiltering').addEventListener('change', (e) => {
            state.effects.delay.filtering = e.target.value;
        });

        // Arpeggiator controls
        document.getElementById('arpToggle').addEventListener('click', () => {
            state.effects.arp.enabled = !state.effects.arp.enabled;
            document.getElementById('arpToggle').classList.toggle('active', state.effects.arp.enabled);
            if (!state.effects.arp.enabled) {
                stopArpeggiator();
                state.effects.arp.heldNotes = [];
            }
        });

        document.getElementById('arpHoldToggle').addEventListener('click', () => {
            state.effects.arp.hold = !state.effects.arp.hold;
            document.getElementById('arpHoldToggle').classList.toggle('active', state.effects.arp.hold);
        });

        document.getElementById('arpOctaveRange').addEventListener('input', (e) => {
            document.getElementById('arpOctaveRangeValue').textContent = e.target.value;
        });

        // Chord controls
        document.getElementById('chordToggle').addEventListener('click', () => {
            state.effects.chord.enabled = !state.effects.chord.enabled;
            document.getElementById('chordToggle').classList.toggle('active', state.effects.chord.enabled);
        });

        document.getElementById('chordInversion').addEventListener('input', (e) => {
            document.getElementById('chordInversionValue').textContent = e.target.value;
        });

        // Transpose controls
        document.getElementById('transposeToggle').addEventListener('click', () => {
            state.effects.transpose.enabled = !state.effects.transpose.enabled;
            document.getElementById('transposeToggle').classList.toggle('active', state.effects.transpose.enabled);
        });

        document.getElementById('transposeSemitones').addEventListener('input', (e) => {
            state.effects.transpose.semitones = parseInt(e.target.value);
            document.getElementById('transposeSemitonesValue').textContent = e.target.value;
        });

        // Velocity controls
        document.getElementById('velocityToggle').addEventListener('click', () => {
            state.effects.velocity.enabled = !state.effects.velocity.enabled;
            document.getElementById('velocityToggle').classList.toggle('active', state.effects.velocity.enabled);
        });

        document.getElementById('velocityMin').addEventListener('input', (e) => {
            state.effects.velocity.min = parseInt(e.target.value);
            document.getElementById('velocityMinValue').textContent = e.target.value;
        });

        document.getElementById('velocityMax').addEventListener('input', (e) => {
            state.effects.velocity.max = parseInt(e.target.value);
            document.getElementById('velocityMaxValue').textContent = e.target.value;
        });

        document.getElementById('velocityRandom').addEventListener('input', (e) => {
            state.effects.velocity.random = parseInt(e.target.value);
            document.getElementById('velocityRandomValue').textContent = e.target.value;
        });

        // Initialize
        initMIDI();
        updateDeviceLists();
    </script>
</body>
</html>

